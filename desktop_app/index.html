<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolf AI Assistant</title>
    <script type="text/javascript" src="/eel.js"></script>
    <link rel="stylesheet" href="wolf.css">
    <!-- Load Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <div class="header-title">
                <div class="wolf-logo">
                    <img src="assets/wolf_avatar.png" alt="Wolf" style="width: 32px; height: 32px;">
                </div>
                <div>
                    <h1>Wolf AI</h1>
                    <p id="system-status-msg">Adaptive Intelligence System</p>
                </div>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="switchMode('ai')">AI Assistant</button>
                <button class="nav-tab" onclick="switchMode('pc')">PC Control</button>
            </nav>
        </header>

        <!-- Status Ribbon -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Synchronized</span>
            </div>
            <div class="model-info">
                <span id="current-model">Llama 3.2</span>
            </div>
            <div>
                <span id="msg-count">0 Pulse Signals</span>
            </div>
        </div>

        <!-- Chat Main Area -->
        <main class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant">
                    <div class="message-avatar">
                        <img src="assets/wolf_avatar.png" alt="Wolf">
                    </div>
                    <div class="message-box">
                        Greetings. I am Wolf, your adaptive intelligence. How shall we proceed today?
                        <span class="message-timestamp" id="welcome-time"></span>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading-indicator" id="loading">
                <div class="loading-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
                <span>Wolf is processing...</span>
            </div>

            <!-- Input Controls Area -->
            <section class="input-area">
                <div class="input-wrapper">
                    <div class="textarea-container">
                        <textarea class="message-input" id="msg-input" placeholder="Transmit command..."
                            rows="1"></textarea>
                    </div>

                    <div class="action-buttons">
                        <button class="icon-btn" id="voice-btn" onclick="startVoiceInput()" title="Voice Interaction">
                            üé§
                        </button>
                        <button class="icon-btn danger" id="kill-btn" onclick="killAI()" title="Abort Protocol"
                            style="display: none;">
                            <span>‚èπ</span>
                        </button>
                        <button class="icon-btn primary" id="send-btn" onclick="transmitMessage()" title="Send Command">
                            <span>‚û§</span>
                        </button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="action-chip" onclick="quickAction('System Status')">System Stats</button>
                    <button class="action-chip" onclick="quickAction('Screenshot')">Capture Screen</button>
                    <button class="action-chip" onclick="openSettings()">Configure</button>
                    <button class="action-chip" onclick="clearConversation()">Wipe Memory</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Settings Overlay -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuration</h2>
            </div>

            <form id="settings-form">
                <div class="form-group">
                    <label>Neural Engine URL</label>
                    <input type="text" class="form-input" id="ollama-url" value="http://localhost:11434">
                </div>

                <div class="form-group">
                    <label>Active Model</label>
                    <select class="form-input" id="model-select">
                        <option value="llama3.2">Llama 3.2 (Primary)</option>
                    </select>
                </div>

                <div style="display: flex; gap: 20px; margin: 24px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="voice-toggle"> Voice Input
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="audio-toggle"> Auto-Speech
                    </label>
                </div>

                <div class="form-group">
                    <label>Audio Intensity</label>
                    <input type="range" class="form-input" id="volume-slider" min="0" max="1" step="0.1">
                </div>
            </form>

            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 32px;">
                <button class="nav-tab" onclick="closeSettings()">Discard</button>
                <button class="nav-tab active" onclick="saveSettings()">Apply Changes</button>
            </div>
        </div>
    </div>

    <script>
        let isTransmitting = false;
        let activeMode = 'ai';

        window.onload = function () {
            document.getElementById('welcome-time').textContent = new Date().toLocaleTimeString();
            syncSettings();
            refreshStatus();
            setupInteractions();
        };

        function setupInteractions() {
            const input = document.getElementById('msg-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    transmitMessage();
                }
            });

            input.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });
        }

        async function syncSettings() {
            try {
                const settings = await eel.get_settings()();
                document.getElementById('ollama-url').value = settings.ollama_url;
                document.getElementById('voice-toggle').checked = settings.voice_enabled;
                document.getElementById('audio-toggle').checked = settings.auto_speak;
                document.getElementById('volume-slider').value = settings.volume;

                const modelData = await eel.get_available_models()();
                const select = document.getElementById('model-select');
                select.innerHTML = '';
                modelData.models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    if (m === modelData.current_model) opt.selected = true;
                    select.appendChild(opt);
                });
            } catch (err) { console.error('Sync error:', err); }
        }

        async function refreshStatus() {
            try {
                const status = await eel.get_system_status()();
                const dot = document.getElementById('status-dot');
                dot.className = status.ollama_status === 'Running' ? 'status-dot' : 'status-dot error';
                document.getElementById('status-text').textContent = status.ollama_status;
                document.getElementById('current-model').textContent = status.current_model || 'Disconnected';
                document.getElementById('msg-count').textContent = `${status.conversation_length} Pulse Signals`;
            } catch (err) { console.error('Status error:', err); }
        }

        async function transmitMessage() {
            if (isTransmitting) return;
            const input = document.getElementById('msg-input');
            const content = input.value.trim();
            if (!content) return;

            isTransmitting = true;
            input.value = '';
            input.style.height = 'auto';

            appendMessage('user', content);
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('kill-btn').style.display = 'flex';

            try {
                const response = await eel.send_message(content)();
                if (response.success) {
                    appendMessage('assistant', response.response, response.image_url);
                } else {
                    appendMessage('assistant', 'Error encountered: ' + response.error);
                }
            } catch (err) {
                appendMessage('assistant', 'Transmission failure.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('kill-btn').style.display = 'none';
                isTransmitting = false;
                refreshStatus();
            }
        }

        async function killAI() {
            if (!isTransmitting) return;
            try {
                await eel.kill_ai_process()();
                appendMessage('assistant', 'Protocol terminated by user. Neural links severed.');
            } catch (err) { console.error('Kill error:', err); }
            finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('kill-btn').style.display = 'none';
                isTransmitting = false;
            }
        }

        function appendMessage(type, content, imageUrl = null) {
            const container = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;

            const avatarImg = type === 'assistant' ? 'assets/wolf_avatar.png' : 'https://ui-avatars.com/api/?name=User&background=1e2a3a&color=fff';

            let html = `
                <div class="message-avatar">
                    <img src="${avatarImg}" alt="${type}">
                </div>
                <div class="message-box">
                    ${content}
                    ${imageUrl ? `<div style="margin-top:12px"><img src="${imageUrl}" style="max-width:100%; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.5)"></div>` : ''}
                    <span class="message-timestamp">${new Date().toLocaleTimeString()}</span>
                </div>
            `;

            msgDiv.innerHTML = html;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function startVoiceInput() {
            const btn = document.getElementById('voice-btn');
            btn.classList.add('voice-active');
            try {
                const res = await eel.start_voice_input()();
                if (res.success) {
                    document.getElementById('msg-input').value = res.text;
                    transmitMessage();
                }
            } catch (err) { console.error('Voice error:', err); }
            finally { btn.classList.remove('voice-active'); }
        }

        function switchMode(mode) {
            activeMode = mode;
            document.querySelectorAll('.nav-tab').forEach(t => {
                t.classList.toggle('active', t.textContent.toLowerCase().includes(mode));
            });

            if (mode === 'pc') {
                eel.get_available_pc_commands()().then(res => {
                    const helpText = "System recognized control protocols: " + res.commands.slice(0, 3).join(', ') + "... Use keywords to execute.";
                    appendMessage('assistant', helpText);
                });
            }
        }

        function quickAction(type) {
            if (type === 'System Status') {
                document.getElementById('msg-input').value = 'Show system info';
                transmitMessage();
            } else if (type === 'Screenshot') {
                document.getElementById('msg-input').value = 'Take a screenshot';
                transmitMessage();
            }
        }

        async function clearConversation() {
            if (confirm('Initiate memory purge?')) {
                await eel.clear_conversation()();
                location.reload();
            }
        }

        function openSettings() { document.getElementById('settings-modal').style.display = 'block'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

        async function saveSettings() {
            const s = {
                ollama_url: document.getElementById('ollama-url').value,
                model: document.getElementById('model-select').value,
                voice_enabled: document.getElementById('voice-toggle').checked,
                auto_speak: document.getElementById('audio-toggle').checked,
                volume: parseFloat(document.getElementById('volume-slider').value)
            };
            await eel.save_settings(s)();
            closeSettings();
            appendMessage('assistant', 'Configuration updated. Neural links synchronized.');
            refreshStatus();
        }
    </script>
</body>

</html>